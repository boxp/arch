From f5d25b1e5995063d223e4d5c55c66ae8819b8070 Mon Sep 17 00:00:00 2001
From: openclaw-agent <openclaw-agent@b0xp.io>
Date: Mon, 16 Feb 2026 10:01:51 +0000
Subject: [PATCH] fix: sanitize tool call IDs for OpenAI Codex 64-char limit

---
 .../openai-codex-call-id-fix/plan.md          | 48 ++++++++++++++++
 src/agents/pi-embedded-helpers/images.ts      |  7 +--
 ...unner.sanitize-session-history.e2e.test.ts |  5 +-
 ...ed-runner.sanitize-session-history.test.ts |  8 ++-
 src/agents/tool-call-id.ts                    | 55 ++++++++++++++++++-
 src/agents/transcript-policy.e2e.test.ts      |  6 +-
 src/agents/transcript-policy.test.ts          |  6 +-
 src/agents/transcript-policy.ts               | 12 ++--
 8 files changed, 127 insertions(+), 20 deletions(-)
 create mode 100644 docs/project_docs/openai-codex-call-id-fix/plan.md

diff --git a/docs/project_docs/openai-codex-call-id-fix/plan.md b/docs/project_docs/openai-codex-call-id-fix/plan.md
new file mode 100644
index 000000000..35d15d6a1
--- /dev/null
+++ b/docs/project_docs/openai-codex-call-id-fix/plan.md
@@ -0,0 +1,48 @@
+# Fix: OpenAI Codex `call_id` string too long error
+
+## Problem
+
+When switching to `openai-codex/gpt-5.3-codex`, the API returns:
+```
+Invalid 'input[2].call_id': string too long. Expected a string with maximum length 64,
+but got a string with length 452 instead.
+```
+
+## Root Cause
+
+Three issues combine to allow long tool call IDs through to the OpenAI Codex API:
+
+1. **`transcript-policy.ts`**: OpenAI providers had `sanitizeToolCallIds: false`, so the `sanitizeToolCallIdsForCloudCodeAssist()` function was never called for OpenAI models.
+
+2. **`pi-embedded-helpers/images.ts`**: The `sanitizeToolCallIds` check was gated behind `allowNonImageSanitization` (which is `false` for OpenAI's `"images-only"` sanitize mode), creating a second barrier preventing tool call ID sanitization.
+
+3. **pi-ai library (`openai-responses-shared.js`)**: The `normalizeToolCallId` function skips IDs without `|` separators, and only applies to `!isSameModel` assistant messages — not to `toolResult` messages.
+
+In cross-model conversations (e.g., Gemini/Anthropic → OpenAI Codex), tool call IDs from previous providers (which can be 400+ chars) pass through all three layers without being truncated.
+
+## Solution
+
+### 1. New `"openai"` tool call ID mode (`tool-call-id.ts`)
+- Added `"openai"` to `ToolCallIdMode` type
+- Allows `[a-zA-Z0-9_-]` characters (matching OpenAI's requirements)
+- Enforces max 64 chars per part
+- Preserves `|` separator for `call_id|item_id` format
+- Handles edge cases: empty parts after sanitization, truncation producing empty strings
+
+### 2. Enable sanitization for OpenAI providers (`transcript-policy.ts`)
+- Added `isOpenAi` to `sanitizeToolCallIds` condition
+- Set `toolCallIdMode: "openai"` for OpenAI providers
+- Removed `!isOpenAi` guard from `sanitizeToolCallIds` return field
+
+### 3. Decouple tool call ID sanitization from sanitize mode (`images.ts`)
+- Removed `allowNonImageSanitization` dependency from `sanitizeToolCallIds` check
+- Tool call ID sanitization now runs regardless of image sanitization mode
+
+## Files Changed
+- `src/agents/tool-call-id.ts`
+- `src/agents/transcript-policy.ts`
+- `src/agents/pi-embedded-helpers/images.ts`
+- `src/agents/transcript-policy.test.ts`
+- `src/agents/transcript-policy.e2e.test.ts`
+- `src/agents/pi-embedded-runner.sanitize-session-history.test.ts`
+- `src/agents/pi-embedded-runner.sanitize-session-history.e2e.test.ts`
diff --git a/src/agents/pi-embedded-helpers/images.ts b/src/agents/pi-embedded-helpers/images.ts
index 9162bb812..3af4dd0a6 100644
--- a/src/agents/pi-embedded-helpers/images.ts
+++ b/src/agents/pi-embedded-helpers/images.ts
@@ -51,10 +51,9 @@ export async function sanitizeSessionMessagesImages(
   const allowNonImageSanitization = sanitizeMode === "full";
   // We sanitize historical session messages because Anthropic can reject a request
   // if the transcript contains oversized base64 images (see MAX_IMAGE_DIMENSION_PX).
-  const sanitizedIds =
-    allowNonImageSanitization && options?.sanitizeToolCallIds
-      ? sanitizeToolCallIdsForCloudCodeAssist(messages, options.toolCallIdMode)
-      : messages;
+  const sanitizedIds = options?.sanitizeToolCallIds
+    ? sanitizeToolCallIdsForCloudCodeAssist(messages, options.toolCallIdMode)
+    : messages;
   const out: AgentMessage[] = [];
   for (const msg of sanitizedIds) {
     if (!msg || typeof msg !== "object") {
diff --git a/src/agents/pi-embedded-runner.sanitize-session-history.e2e.test.ts b/src/agents/pi-embedded-runner.sanitize-session-history.e2e.test.ts
index d4f4488b6..472551887 100644
--- a/src/agents/pi-embedded-runner.sanitize-session-history.e2e.test.ts
+++ b/src/agents/pi-embedded-runner.sanitize-session-history.e2e.test.ts
@@ -52,7 +52,7 @@ describe("sanitizeSessionHistory e2e smoke", () => {
     );
   });
 
-  it("keeps images-only sanitize policy without tool-call id rewriting for openai-responses", async () => {
+  it("uses images-only sanitize policy with openai tool-call id mode for openai-responses", async () => {
     vi.mocked(helpers.isGoogleModelApi).mockReturnValue(false);
 
     await sanitizeSessionHistory({
@@ -68,7 +68,8 @@ describe("sanitizeSessionHistory e2e smoke", () => {
       "session:history",
       expect.objectContaining({
         sanitizeMode: "images-only",
-        sanitizeToolCallIds: false,
+        sanitizeToolCallIds: true,
+        toolCallIdMode: "openai",
       }),
     );
   });
diff --git a/src/agents/pi-embedded-runner.sanitize-session-history.test.ts b/src/agents/pi-embedded-runner.sanitize-session-history.test.ts
index ca463a2e3..cb9ff1b7d 100644
--- a/src/agents/pi-embedded-runner.sanitize-session-history.test.ts
+++ b/src/agents/pi-embedded-runner.sanitize-session-history.test.ts
@@ -98,7 +98,7 @@ describe("sanitizeSessionHistory", () => {
     );
   });
 
-  it("does not sanitize tool call ids for openai-responses", async () => {
+  it("sanitizes tool call ids with openai mode for openai-responses", async () => {
     vi.mocked(helpers.isGoogleModelApi).mockReturnValue(false);
 
     await sanitizeSessionHistory({
@@ -112,7 +112,11 @@ describe("sanitizeSessionHistory", () => {
     expect(helpers.sanitizeSessionMessagesImages).toHaveBeenCalledWith(
       mockMessages,
       "session:history",
-      expect.objectContaining({ sanitizeMode: "images-only", sanitizeToolCallIds: false }),
+      expect.objectContaining({
+        sanitizeMode: "images-only",
+        sanitizeToolCallIds: true,
+        toolCallIdMode: "openai",
+      }),
     );
   });
 
diff --git a/src/agents/tool-call-id.ts b/src/agents/tool-call-id.ts
index ed7476b94..80306830a 100644
--- a/src/agents/tool-call-id.ts
+++ b/src/agents/tool-call-id.ts
@@ -1,9 +1,10 @@
 import type { AgentMessage } from "@mariozechner/pi-agent-core";
 import { createHash } from "node:crypto";
 
-export type ToolCallIdMode = "strict" | "strict9";
+export type ToolCallIdMode = "strict" | "strict9" | "openai";
 
 const STRICT9_LEN = 9;
+const OPENAI_MAX_LEN = 64;
 const TOOL_CALL_TYPES = new Set(["toolCall", "toolUse", "functionCall"]);
 
 export type ToolCallLike = {
@@ -36,6 +37,27 @@ export function sanitizeToolCallId(id: string, mode: ToolCallIdMode = "strict"):
     return shortHash("sanitized", STRICT9_LEN);
   }
 
+  if (mode === "openai") {
+    // OpenAI Responses API allows [a-zA-Z0-9_-] with max 64 chars per part.
+    // Preserve "|" separator for call_id|item_id format used by OpenAI Responses.
+    if (id.includes("|")) {
+      const parts = id.split("|");
+      const sanitized = parts
+        .map((part) => {
+          const clean = part.replace(/[^a-zA-Z0-9_-]/g, "_").replace(/_+$/, "");
+          return clean.length > OPENAI_MAX_LEN ? clean.slice(0, OPENAI_MAX_LEN).replace(/_+$/, "") : clean;
+        })
+        .filter((part) => part.length > 0);
+      return sanitized.length > 0 ? sanitized.join("|") : "call_sanitized";
+    }
+    const clean = id.replace(/[^a-zA-Z0-9_-]/g, "_").replace(/_+$/, "");
+    if (clean.length <= OPENAI_MAX_LEN) {
+      return clean || "call_sanitized";
+    }
+    const truncated = clean.slice(0, OPENAI_MAX_LEN).replace(/_+$/, "");
+    return truncated || "call_sanitized";
+  }
+
   // Some providers require strictly alphanumeric tool call IDs.
   const alphanumericOnly = id.replace(/[^a-zA-Z0-9]/g, "");
   return alphanumericOnly.length > 0 ? alphanumericOnly : "sanitizedtoolid";
@@ -89,6 +111,11 @@ export function isValidCloudCodeAssistToolId(id: string, mode: ToolCallIdMode =
   if (mode === "strict9") {
     return /^[a-zA-Z0-9]{9}$/.test(id);
   }
+  if (mode === "openai") {
+    // OpenAI allows [a-zA-Z0-9_-], max 64 chars per part, "|" as separator
+    const parts = id.split("|");
+    return parts.every((part) => /^[a-zA-Z0-9_-]+$/.test(part) && part.length <= OPENAI_MAX_LEN);
+  }
   // Strictly alphanumeric for providers with tighter tool ID constraints
   return /^[a-zA-Z0-9]+$/.test(id);
 }
@@ -115,6 +142,32 @@ function makeUniqueToolId(params: { id: string; used: Set<string>; mode: ToolCal
     return shortHash(`${params.id}:${Date.now()}`, STRICT9_LEN);
   }
 
+  if (params.mode === "openai") {
+    const base = sanitizeToolCallId(params.id, params.mode);
+    if (!params.used.has(base)) {
+      return base;
+    }
+
+    const hash = shortHash(params.id);
+    const maxBaseLen = OPENAI_MAX_LEN - 1 - hash.length; // 1 for "_"
+    const clippedBase = base.slice(0, maxBaseLen);
+    const candidate = `${clippedBase}_${hash}`;
+    if (!params.used.has(candidate)) {
+      return candidate;
+    }
+
+    for (let i = 2; i < 1000; i += 1) {
+      const suffix = `_${i}`;
+      const next = `${candidate.slice(0, OPENAI_MAX_LEN - suffix.length)}${suffix}`;
+      if (!params.used.has(next)) {
+        return next;
+      }
+    }
+
+    const ts = `_${Date.now()}`;
+    return `${candidate.slice(0, OPENAI_MAX_LEN - ts.length)}${ts}`;
+  }
+
   const MAX_LEN = 40;
 
   const base = sanitizeToolCallId(params.id, params.mode).slice(0, MAX_LEN);
diff --git a/src/agents/transcript-policy.e2e.test.ts b/src/agents/transcript-policy.e2e.test.ts
index 58f23e21c..ea949f157 100644
--- a/src/agents/transcript-policy.e2e.test.ts
+++ b/src/agents/transcript-policy.e2e.test.ts
@@ -2,15 +2,15 @@ import { describe, expect, it } from "vitest";
 import { resolveTranscriptPolicy } from "./transcript-policy.js";
 
 describe("resolveTranscriptPolicy e2e smoke", () => {
-  it("uses images-only sanitization without tool-call id rewriting for OpenAI models", () => {
+  it("uses images-only sanitization with openai tool-call id mode for OpenAI models", () => {
     const policy = resolveTranscriptPolicy({
       provider: "openai",
       modelId: "gpt-4o",
       modelApi: "openai",
     });
     expect(policy.sanitizeMode).toBe("images-only");
-    expect(policy.sanitizeToolCallIds).toBe(false);
-    expect(policy.toolCallIdMode).toBeUndefined();
+    expect(policy.sanitizeToolCallIds).toBe(true);
+    expect(policy.toolCallIdMode).toBe("openai");
   });
 
   it("uses strict9 tool-call sanitization for Mistral-family models", () => {
diff --git a/src/agents/transcript-policy.test.ts b/src/agents/transcript-policy.test.ts
index 56c1230b6..82b592382 100644
--- a/src/agents/transcript-policy.test.ts
+++ b/src/agents/transcript-policy.test.ts
@@ -30,13 +30,13 @@ describe("resolveTranscriptPolicy", () => {
     expect(policy.toolCallIdMode).toBe("strict9");
   });
 
-  it("disables sanitizeToolCallIds for OpenAI provider", () => {
+  it("enables sanitizeToolCallIds with openai mode for OpenAI provider", () => {
     const policy = resolveTranscriptPolicy({
       provider: "openai",
       modelId: "gpt-4o",
       modelApi: "openai",
     });
-    expect(policy.sanitizeToolCallIds).toBe(false);
-    expect(policy.toolCallIdMode).toBeUndefined();
+    expect(policy.sanitizeToolCallIds).toBe(true);
+    expect(policy.toolCallIdMode).toBe("openai");
   });
 });
diff --git a/src/agents/transcript-policy.ts b/src/agents/transcript-policy.ts
index 22e173320..191b76227 100644
--- a/src/agents/transcript-policy.ts
+++ b/src/agents/transcript-policy.ts
@@ -95,12 +95,14 @@ export function resolveTranscriptPolicy(params: {
 
   const needsNonImageSanitize = isGoogle || isAnthropic || isMistral || isOpenRouterGemini;
 
-  const sanitizeToolCallIds = isGoogle || isMistral || isAnthropic;
+  const sanitizeToolCallIds = isGoogle || isMistral || isAnthropic || isOpenAi;
   const toolCallIdMode: ToolCallIdMode | undefined = isMistral
     ? "strict9"
-    : sanitizeToolCallIds
-      ? "strict"
-      : undefined;
+    : isOpenAi
+      ? "openai"
+      : sanitizeToolCallIds
+        ? "strict"
+        : undefined;
   const repairToolUseResultPairing = isGoogle || isAnthropic;
   const sanitizeThoughtSignatures = isOpenRouterGemini
     ? { allowBase64Only: true, includeCamelCase: true }
@@ -109,7 +111,7 @@ export function resolveTranscriptPolicy(params: {
 
   return {
     sanitizeMode: isOpenAi ? "images-only" : needsNonImageSanitize ? "full" : "images-only",
-    sanitizeToolCallIds: !isOpenAi && sanitizeToolCallIds,
+    sanitizeToolCallIds,
     toolCallIdMode,
     repairToolUseResultPairing: !isOpenAi && repairToolUseResultPairing,
     preserveSignatures: isAntigravityClaudeModel,
-- 
2.39.5

