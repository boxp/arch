---
- name: Configure Orange Pi Zero 3 control plane nodes
  hosts: control_plane
  become: true
  gather_facts: true
  vars:
    # Common cluster configuration
    cluster_vip: "192.168.10.99"
    cluster_domain: "cluster.local"
    cluster_dns: "10.96.0.10"

  tasks:
    - name: Ensure SSH server is installed and configured
      tags: [ssh, bootstrap]
      block:
        - name: Install OpenSSH server
          ansible.builtin.apt:
            name: openssh-server
            state: present
            update_cache: true
          tags: [ssh, bootstrap]

        - name: Ensure SSH service is enabled and started
          ansible.builtin.systemd:
            name: ssh
            enabled: true
            state: started
          tags: [ssh, bootstrap]

        - name: Configure SSH server
          ansible.builtin.lineinfile:
            path: /etc/ssh/sshd_config
            regexp: "{{ item.regexp }}"
            line: "{{ item.line }}"
            validate: 'sshd -t -f %s'
          loop:
            - { regexp: '^#?PermitRootLogin', line: 'PermitRootLogin no' }
            - { regexp: '^#?PasswordAuthentication', line: 'PasswordAuthentication no' }
            - { regexp: '^#?PubkeyAuthentication', line: 'PubkeyAuthentication yes' }
            - { regexp: '^#?ChallengeResponseAuthentication', line: 'ChallengeResponseAuthentication no' }
          notify: Restart SSH service
          tags: [ssh, bootstrap]

  handlers:
    - name: Restart SSH service
      ansible.builtin.systemd:
        name: ssh
        state: restarted

  roles:
    - role: user_management
      tags: [users, bootstrap]
    - role: network_configuration
      tags: [network, bootstrap]
      vars:
        network_ip_address: "{{ node_ip }}"
        network_gateway: "192.168.10.1"

    - role: cloudflare_cli
      tags: [cloudflare, external-access]
    - role: kubernetes_components
      tags: [kubernetes, k8s-components]
      vars:
        kubernetes_version: "1.32"
        kubernetes_package_version: "1.32.0-1.1"
        crio_version: "1.32"
        kubelet_cluster_dns: "{{ cluster_dns }}"
        kubelet_cluster_domain: "{{ cluster_domain }}"
    - role: kube_vip
      tags: [kube-vip, ha]
      vars:
        kube_vip_vip: "{{ cluster_vip }}"
        kube_vip_interface: "eth0"
        kube_vip_control_plane: true
        kube_vip_services: false
