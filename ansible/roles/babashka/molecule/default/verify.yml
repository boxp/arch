---
- name: Verify
  hosts: all
  gather_facts: true
  tasks:
    - name: Check if bb binary exists
      ansible.builtin.stat:
        path: /usr/local/bin/bb
      register: bb_binary

    - name: Assert bb binary exists
      ansible.builtin.assert:
        that:
          - bb_binary.stat.exists
          - bb_binary.stat.executable
        fail_msg: "Babashka binary does not exist or is not executable at /usr/local/bin/bb"

    - name: Check bb version output
      ansible.builtin.command:
        cmd: /usr/local/bin/bb --version
      register: bb_version
      changed_when: false

    - name: Assert bb version is correct
      ansible.builtin.assert:
        that:
          - "'babashka v' in bb_version.stdout"
        fail_msg: "Babashka version output is unexpected: {{ bb_version.stdout }}"

    - name: Test bb script execution
      ansible.builtin.command:
        cmd: /usr/local/bin/bb -e '(println "hello")'
      register: bb_script
      changed_when: false

    - name: Assert bb script executed correctly
      ansible.builtin.assert:
        that:
          - bb_script.stdout == "hello"
        fail_msg: "Babashka script execution failed: {{ bb_script.stdout }}"

    - name: Run role again for idempotency check
      ansible.builtin.include_role:
        name: "arch.babashka"

    - name: Check babashka_needs_install flag after second run
      ansible.builtin.assert:
        that:
          - not (babashka_needs_install | bool)
        fail_msg: "Idempotency failed: babashka_needs_install is still true on second run"

    - name: Verify version unchanged after idempotent run
      ansible.builtin.command:
        cmd: /usr/local/bin/bb --version
      register: bb_version_after
      changed_when: false

    - name: Assert version unchanged after idempotent run
      ansible.builtin.assert:
        that:
          - bb_version.stdout == bb_version_after.stdout
        fail_msg: "Babashka version changed after idempotent run"
