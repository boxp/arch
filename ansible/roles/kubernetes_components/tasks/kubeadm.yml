---
# Kubeadm configuration tasks

- name: Create kubeadm configuration directory
  ansible.builtin.file:
    path: /etc/kubernetes
    state: directory
    mode: '0755'
  become: true

- name: Deploy kubeadm configuration with etcd tuning
  ansible.builtin.template:
    src: kubeadm-config.yaml.j2
    dest: /etc/kubernetes/kubeadm-config.yaml
    mode: '0644'
    owner: root
    group: root
  become: true
  when:
    - inventory_hostname in groups['control_plane'] | default([])

- name: Check if etcd manifest exists
  ansible.builtin.stat:
    path: /etc/kubernetes/manifests/etcd.yaml
  register: etcd_manifest
  become: true
  when:
    - inventory_hostname in groups['control_plane'] | default([])

- name: Update etcd CPU resource request in manifest
  ansible.builtin.lineinfile:
    path: /etc/kubernetes/manifests/etcd.yaml
    regexp: '^\s+cpu:\s+\d+m\s*$'
    line: '      cpu: {{ etcd_resource_requests_cpu }}'
    backrefs: true
    backup: true
  become: true
  when:
    - inventory_hostname in groups['control_plane'] | default([])
    - etcd_manifest.stat.exists | default(false)

- name: Update etcd memory resource request in manifest
  ansible.builtin.lineinfile:
    path: /etc/kubernetes/manifests/etcd.yaml
    regexp: '^\s+memory:\s+\d+Mi\s*$'
    line: '      memory: {{ etcd_resource_requests_memory }}'
    backrefs: true
  become: true
  when:
    - inventory_hostname in groups['control_plane'] | default([])
    - etcd_manifest.stat.exists | default(false)
