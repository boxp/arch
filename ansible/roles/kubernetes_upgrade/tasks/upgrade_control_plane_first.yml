---
- name: Drain control plane node
  ansible.builtin.command: >
    kubectl --kubeconfig={{ kubeconfig_path }} drain {{ inventory_hostname }}
    --ignore-daemonsets --delete-emptydir-data
    --timeout={{ upgrade_drain_timeout }}s
  become: true
  changed_when: true
  tags: [upgrade]

- name: Update apt source and install packages
  ansible.builtin.include_tasks: upgrade_apt_source.yml
  tags: [upgrade]

- name: Unhold kubeadm
  ansible.builtin.dpkg_selections:
    name: kubeadm
    selection: install
  become: true
  tags: [upgrade]

- name: Install target kubeadm version
  ansible.builtin.apt:
    name: "kubeadm={{ kubernetes_upgrade_package }}"
    state: present
    allow_downgrade: false
  become: true
  tags: [upgrade]

- name: Hold kubeadm
  ansible.builtin.dpkg_selections:
    name: kubeadm
    selection: hold
  become: true
  tags: [upgrade]

- name: Run kubeadm upgrade apply
  ansible.builtin.command: "kubeadm upgrade apply v{{ kubernetes_upgrade_version }} --yes"
  become: true
  register: upgrade_result
  changed_when: upgrade_result.rc == 0
  tags: [upgrade]

- name: Upgrade kubelet and kubectl
  ansible.builtin.include_tasks: upgrade_kubelet_kubectl.yml
  tags: [upgrade]

- name: Restart kubelet
  ansible.builtin.systemd:
    name: kubelet
    state: restarted
    daemon_reload: true
  become: true
  tags: [upgrade]

- name: Uncordon control plane node
  ansible.builtin.command: "kubectl --kubeconfig={{ kubeconfig_path }} uncordon {{ inventory_hostname }}"
  become: true
  changed_when: true
  tags: [upgrade]

- name: Wait for node to become Ready
  ansible.builtin.include_tasks: health_check.yml
  tags: [upgrade]
