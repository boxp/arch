---
# upgrade_control_plane_first.yml â€” Upgrade first control plane node (kubeadm upgrade apply)

- name: Drain control plane node
  ansible.builtin.command: >
    kubectl drain {{ inventory_hostname }}
    --ignore-daemonsets --delete-emptydir-data
    --timeout={{ upgrade_drain_timeout }}s
  environment:
    KUBECONFIG: "{{ kubernetes_admin_conf }}"
  become: true
  changed_when: true
  tags: [upgrade]

- name: Update apt source and install packages
  ansible.builtin.include_tasks: upgrade_apt_source.yml
  tags: [upgrade]

- name: Run kubeadm upgrade apply
  ansible.builtin.command: "kubeadm upgrade apply v{{ kubernetes_upgrade_version }} --yes"
  become: true
  register: upgrade_result
  changed_when: upgrade_result.rc == 0
  tags: [upgrade]

- name: Display kubeadm upgrade result
  ansible.builtin.debug:
    msg: "{{ upgrade_result.stdout_lines | default([]) }}"
  tags: [upgrade]

- name: Upgrade kubelet and kubectl
  ansible.builtin.include_tasks: upgrade_kubelet_kubectl.yml
  tags: [upgrade]

- name: Restart kubelet
  ansible.builtin.systemd:
    name: kubelet
    state: restarted
    daemon_reload: true
  become: true
  tags: [upgrade]

- name: Uncordon control plane node
  ansible.builtin.command: "kubectl uncordon {{ inventory_hostname }}"
  environment:
    KUBECONFIG: "{{ kubernetes_admin_conf }}"
  become: true
  changed_when: true
  tags: [upgrade]

- name: Wait for node to become Ready
  ansible.builtin.include_tasks: health_check.yml
  tags: [upgrade]
