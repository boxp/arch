---
# upgrade_control_plane_secondary.yml â€” Upgrade secondary control plane nodes (kubeadm upgrade node)

- name: Drain control plane node
  ansible.builtin.command: >
    kubectl drain {{ inventory_hostname }}
    --ignore-daemonsets --delete-emptydir-data
    --timeout={{ upgrade_drain_timeout }}s
  environment:
    KUBECONFIG: "{{ kubernetes_admin_conf }}"
  delegate_to: "{{ groups['control_plane'][0] }}"
  become: true
  changed_when: true
  tags: [upgrade]

- name: Update apt source and install packages
  ansible.builtin.include_tasks: upgrade_apt_source.yml
  tags: [upgrade]

- name: Run kubeadm upgrade node
  ansible.builtin.command: kubeadm upgrade node
  become: true
  register: upgrade_node_result
  changed_when: upgrade_node_result.rc == 0
  tags: [upgrade]

- name: Display kubeadm upgrade node result
  ansible.builtin.debug:
    msg: "{{ upgrade_node_result.stdout_lines | default([]) }}"
  tags: [upgrade]

- name: Upgrade kubelet and kubectl
  ansible.builtin.include_tasks: upgrade_kubelet_kubectl.yml
  tags: [upgrade]

- name: Restart kubelet
  ansible.builtin.systemd:
    name: kubelet
    state: restarted
    daemon_reload: true
  become: true
  tags: [upgrade]

- name: Uncordon control plane node
  ansible.builtin.command: "kubectl uncordon {{ inventory_hostname }}"
  environment:
    KUBECONFIG: "{{ kubernetes_admin_conf }}"
  delegate_to: "{{ groups['control_plane'][0] }}"
  become: true
  changed_when: true
  tags: [upgrade]

- name: Verify node health
  ansible.builtin.include_tasks: health_check.yml
  tags: [upgrade]
