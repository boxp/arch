---
- name: Drain worker node
  ansible.builtin.command: >
    kubectl --kubeconfig={{ kubeconfig_path }} drain {{ inventory_hostname }}
    --ignore-daemonsets --delete-emptydir-data
    --timeout={{ upgrade_drain_timeout }}s
  delegate_to: "{{ groups['control_plane'][0] }}"
  become: true
  changed_when: true
  tags: [upgrade]

- name: Update apt source and install packages
  ansible.builtin.include_tasks: upgrade_apt_source.yml
  tags: [upgrade]

- name: Unhold kubeadm
  ansible.builtin.dpkg_selections:
    name: kubeadm
    selection: install
  become: true
  tags: [upgrade]

- name: Install target kubeadm version
  ansible.builtin.apt:
    name: "kubeadm={{ kubernetes_upgrade_package }}"
    state: present
    allow_downgrade: false
  become: true
  tags: [upgrade]

- name: Hold kubeadm
  ansible.builtin.dpkg_selections:
    name: kubeadm
    selection: hold
  become: true
  tags: [upgrade]

- name: Run kubeadm upgrade node
  ansible.builtin.command: kubeadm upgrade node
  become: true
  changed_when: true
  tags: [upgrade]

- name: Upgrade kubelet and kubectl
  ansible.builtin.include_tasks: upgrade_kubelet_kubectl.yml
  tags: [upgrade]

- name: Restart kubelet
  ansible.builtin.systemd:
    name: kubelet
    state: restarted
    daemon_reload: true
  become: true
  tags: [upgrade]

- name: Reboot worker node
  ansible.builtin.reboot:
    reboot_timeout: 300
  become: true
  tags: [upgrade]

- name: Uncordon worker node
  ansible.builtin.command: "kubectl --kubeconfig={{ kubeconfig_path }} uncordon {{ inventory_hostname }}"
  delegate_to: "{{ groups['control_plane'][0] }}"
  become: true
  changed_when: true
  tags: [upgrade]

- name: Verify node health
  ansible.builtin.include_tasks: health_check.yml
  tags: [upgrade]
