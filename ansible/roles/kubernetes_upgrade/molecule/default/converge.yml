---
- name: Converge
  hosts: all
  become: true
  vars:
    # Test upgrade versions
    kubernetes_upgrade_version: "1.35.1"
    kubernetes_upgrade_package: "1.35.1-1.1"
    crio_upgrade_version: "1.35.0"
    kubernetes_previous_version: "1.34"
    kubernetes_previous_package: "1.34.0-1.1"
    crio_previous_version: "1.34"
    # Role detection for first control plane
    node_role: control_plane
    is_first_control_plane: true
    # Snapshot timestamp for rollback test
    snapshot_timestamp: "20260214T000000"
    etcd_initial_cluster: "instance=https://192.168.10.102:2380"
  tasks:
    # Test pre_checks tasks (with mocked commands)
    - name: Test pre-checks
      ansible.builtin.include_role:
        name: kubernetes_upgrade
        tasks_from: pre_checks.yml
      tags: [pre_checks]

    # Test etcd snapshot tasks (with mocked etcdctl)
    - name: Test etcd snapshot
      ansible.builtin.include_role:
        name: kubernetes_upgrade
        tasks_from: etcd_snapshot.yml
      tags: [etcd_snapshot]

    # Test apt source template rendering
    - name: Test apt source update
      ansible.builtin.template:
        src: "{{ playbook_dir }}/../../templates/kubernetes.list.j2"
        dest: /etc/apt/sources.list.d/kubernetes.list
        mode: '0644'
      tags: [upgrade]

    # Test health check tasks (with mocked kubectl)
    - name: Test health check
      ansible.builtin.include_role:
        name: kubernetes_upgrade
        tasks_from: health_check.yml
      tags: [health_check]
