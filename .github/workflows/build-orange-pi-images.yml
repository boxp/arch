name: Build Orange Pi Zero 3 Images

on:
  workflow_dispatch:
    inputs:
      node_name:
        description: 'Node to build (leave empty to build all)'
        required: false
        type: choice
        options:
          - ''
          - shanghai-1
          - shanghai-2
          - shanghai-3
  push:
    paths:
      - 'ansible/playbooks/node-*.yml'
      - 'ansible/roles/**'
      - 'armbian-build/userpatches/**'
      - '.github/workflows/build-orange-pi-images.yml'
      - '.github/actions/build-orange-pi-image/**'

jobs:
  determine-nodes:
    runs-on: ubuntu-latest
    outputs:
      nodes: ${{ steps.set-nodes.outputs.nodes }}
    steps:
      - name: Determine nodes to build
        id: set-nodes
        run: |
          if [ -n "${{ github.event.inputs.node_name }}" ]; then
            echo "nodes=[\"${{ github.event.inputs.node_name }}\"]" >> $GITHUB_OUTPUT
          else
            echo "nodes=[\"shanghai-1\", \"shanghai-2\", \"shanghai-3\"]" >> $GITHUB_OUTPUT
          fi

  build-images:
    needs: determine-nodes
    runs-on: ubuntu-latest
    permissions:
      id-token: write
      contents: read
    strategy:
      matrix:
        node: ${{ fromJson(needs.determine-nodes.outputs.nodes) }}
      fail-fast: false
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Build Orange Pi image for ${{ matrix.node }}
        uses: ./.github/actions/build-orange-pi-image
        with:
          node_name: ${{ matrix.node }}
          aws_role_arn: ${{ vars.AWS_ROLE_ARN }}
          s3_bucket: ${{ vars.S3_BUCKET_NAME }}

      - name: Build summary
        run: |
          echo "## Build Summary for ${{ matrix.node }}" >> $GITHUB_STEP_SUMMARY
          echo "- **Node**: ${{ matrix.node }}" >> $GITHUB_STEP_SUMMARY
          echo "- **Image**: orangepi-zero3-${{ matrix.node }}.img.xz" >> $GITHUB_STEP_SUMMARY
          echo "- **Size**: $(du -h orangepi-zero3-${{ matrix.node }}.img.xz | cut -f1)" >> $GITHUB_STEP_SUMMARY
          echo "- **Checksum**: $(cat orangepi-zero3-${{ matrix.node }}.img.xz.sha256 | cut -d' ' -f1)" >> $GITHUB_STEP_SUMMARY
          echo "- **S3 Path**: s3://${{ vars.S3_BUCKET_NAME }}/images/orange-pi-zero3/${{ matrix.node }}/" >> $GITHUB_STEP_SUMMARY