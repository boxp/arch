name: Apply Ansible

on:
  push:
    branches: [main]
    paths:
      - 'ansible/**'
      - '.github/workflows/apply-ansible.yml'

jobs:
  apply:
    runs-on: ubuntu-latest
    permissions:
      id-token: write
      contents: read
    strategy:
      matrix:
        node: [shanghai-1, shanghai-2, shanghai-3]
      max-parallel: 1
      fail-fast: true
    env:
      NODE_IPS: '{"shanghai-1":"192.168.10.102","shanghai-2":"192.168.10.103","shanghai-3":"192.168.10.104"}'
    steps:
      - name: Checkout
        uses: actions/checkout@de0fac2e4500dabe0009e67214ff5f5447ce83dd # v6.0.2

      - name: Configure AWS credentials
        uses: aws-actions/configure-aws-credentials@61815dcd50bd041e203e49132bacad1fd04d2708 # v5.1.1
        with:
          role-to-assume: arn:aws:iam::839695154978:role/GitHubActions_Ansible_Apply
          aws-region: ap-northeast-1

      - name: Setup Cloudflare credentials
        id: cf-credentials
        run: |
          # Get Cloudflare Access credentials with retry logic
          CF_ID=""
          for i in 1 2 3; do
            CF_ID=$(aws ssm get-parameter --name "bastion-cf-access-client-id" --with-decryption --query "Parameter.Value" --output text) && break
            echo "Retry $i: Failed to get CF_ACCESS_CLIENT_ID"
            sleep 5
          done
          if [ -z "$CF_ID" ]; then
            echo "::error::Failed to retrieve CF_ACCESS_CLIENT_ID after 3 attempts"
            exit 1
          fi

          CF_SECRET=""
          for i in 1 2 3; do
            CF_SECRET=$(aws ssm get-parameter --name "bastion-cf-access-client-secret" --with-decryption --query "Parameter.Value" --output text) && break
            echo "Retry $i: Failed to get CF_ACCESS_CLIENT_SECRET"
            sleep 5
          done
          if [ -z "$CF_SECRET" ]; then
            echo "::error::Failed to retrieve CF_ACCESS_CLIENT_SECRET after 3 attempts"
            exit 1
          fi

          # Mask secrets in logs
          echo "::add-mask::$CF_ID"
          echo "::add-mask::$CF_SECRET"

          echo "CF_ACCESS_CLIENT_ID=$CF_ID" >> "$GITHUB_ENV"
          echo "CF_ACCESS_CLIENT_SECRET=$CF_SECRET" >> "$GITHUB_ENV"

      - name: Setup SSH key
        run: |
          mkdir -p ~/.ssh
          echo "${{ secrets.ANSIBLE_SSH_PRIVATE_KEY }}" > ~/.ssh/id_ed25519
          chmod 600 ~/.ssh/id_ed25519

      - name: Install aqua
        uses: aquaproj/aqua-installer@f6be09d5313d3af86e3ad665911c67b149a4498c # v4.0.4
        with:
          aqua_version: v2.56.5
          working_directory: aqua

      - name: Setup SSH config
        run: |
          NODE_IP=$(echo '${{ env.NODE_IPS }}' | jq -r '."${{ matrix.node }}"')

          # Configure SSH to route through bastion for the target node IP
          cat >> ~/.ssh/config << EOF
          Host bastion
            HostName bastion.b0xp.io
            User ansible
            IdentityFile ~/.ssh/id_ed25519
            ProxyCommand cloudflared access ssh --hostname %h --header "CF-Access-Client-Id: $CF_ACCESS_CLIENT_ID" --header "CF-Access-Client-Secret: $CF_ACCESS_CLIENT_SECRET"
            StrictHostKeyChecking accept-new

          # Match by IP address (used by ansible_host)
          Host ${NODE_IP}
            HostName ${NODE_IP}
            User boxp
            IdentityFile ~/.ssh/id_ed25519
            ProxyJump bastion
            StrictHostKeyChecking accept-new
          EOF

          chmod 600 ~/.ssh/config

      - name: Verify SSH connectivity
        run: |
          NODE_IP=$(echo '${{ env.NODE_IPS }}' | jq -r '."${{ matrix.node }}"')
          echo "Testing SSH connectivity to ${{ matrix.node }} (${NODE_IP}) via bastion..."
          ssh -o ConnectTimeout=60 "${NODE_IP}" "echo 'SSH connection successful to ${{ matrix.node }}'"

      - name: Set up Python
        uses: actions/setup-python@a309ff8b426b58ec0e2a45f0f869d46889d02405 # v6.2.0
        with:
          python-version: '3.12'

      - name: Install uv
        uses: astral-sh/setup-uv@61cb8a9741eeb8a550a1b8544337180c0fc8476b # v7.2.0

      - name: Install dependencies
        run: |
          cd ansible
          uv sync

      - name: Run control-plane playbook
        run: |
          cd ansible
          source .venv/bin/activate

          echo "Running control-plane playbook on node: ${{ matrix.node }}"
          ansible-playbook \
            -i inventories/production/hosts.yml \
            playbooks/control-plane.yml \
            --limit ${{ matrix.node }} \
            -e "ansible_ssh_common_args=''" \
            -e "node_name=${{ matrix.node }}" \
            -v

      - name: Run node-specific playbook
        run: |
          cd ansible
          source .venv/bin/activate

          NODE="${{ matrix.node }}"
          PLAYBOOK="playbooks/node-${NODE}.yml"

          if [ -f "$PLAYBOOK" ]; then
            echo "Running node-specific playbook for: $NODE"
            ansible-playbook \
              -i inventories/production/hosts.yml \
              "$PLAYBOOK" \
              --limit "${NODE}" \
              -e "ansible_ssh_common_args=''" \
              -e "node_name=${NODE}" \
              -v
          else
            echo "No node-specific playbook found for: $NODE (skipping)"
          fi
